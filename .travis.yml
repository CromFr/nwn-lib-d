language: d
d: dmd

before_install:
  - sudo apt-get -qq update
  - sudo apt-get install -y gcc-multilib libevent-dev
  - .travis/build-win.sh before_install
  - mkdir bin/

script:
  # Test
  - dub test -a x86                    :nwn-gff
  - dub test -a x86_64 -b unittest-cov :nwn-gff
  - dub test -a x86                    :nwn-trn
  - dub test -a x86_64 -b unittest-cov :nwn-trn

  # Doc
  - dub build --build=ddox

  # Source wine env
  - . .travis/build-win.sh

  # Release objects
  - dub build      -b release -a x86    :nwn-gff  &&  mv nwn-gff     bin/nwn-gff.linux-x86
  - dub build      -b release -a x86_64 :nwn-gff  &&  mv nwn-gff     bin/nwn-gff.linux-x86_64
  - wine dub build -b release -a x86    :nwn-gff  &&  mv nwn-gff.exe bin/nwn-gff.win-x86
  - wine dub build -b release -a x86_64 :nwn-gff  &&  mv nwn-gff.exe bin/nwn-gff.win-x86_64

  - dub build      -b release -a x86    :nwn-erf  &&  mv nwn-erf     bin/nwn-erf.linux-x86
  - dub build      -b release -a x86_64 :nwn-erf  &&  mv nwn-erf     bin/nwn-erf.linux-x86_64
  - wine dub build -b release -a x86    :nwn-erf  &&  mv nwn-erf.exe bin/nwn-erf.win-x86
  - wine dub build -b release -a x86_64 :nwn-erf  &&  mv nwn-erf.exe bin/nwn-erf.win-x86_64

  - dub build      -b release -a x86    :nwn-tlk  &&  mv nwn-tlk     bin/nwn-tlk.linux-x86
  - dub build      -b release -a x86_64 :nwn-tlk  &&  mv nwn-tlk     bin/nwn-tlk.linux-x86_64
  - wine dub build -b release -a x86    :nwn-tlk  &&  mv nwn-tlk.exe bin/nwn-tlk.win-x86
  - wine dub build -b release -a x86_64 :nwn-tlk  &&  mv nwn-tlk.exe bin/nwn-tlk.win-x86_64

  - dub build      -b release -a x86    :nwn-bdb  &&  mv nwn-bdb     bin/nwn-bdb.linux-x86
  - dub build      -b release -a x86_64 :nwn-bdb  &&  mv nwn-bdb     bin/nwn-bdb.linux-x86_64
  - wine dub build -b release -a x86    :nwn-bdb  &&  mv nwn-bdb.exe bin/nwn-bdb.win-x86
  - wine dub build -b release -a x86_64 :nwn-bdb  &&  mv nwn-bdb.exe bin/nwn-bdb.win-x86_64

  - dub build      -b release -a x86    :nwn-trn  &&  mv nwn-trn     bin/nwn-trn.linux-x86
  - dub build      -b release -a x86_64 :nwn-trn  &&  mv nwn-trn     bin/nwn-trn.linux-x86_64
  - wine dub build -b release -a x86    :nwn-trn  &&  mv nwn-trn.exe bin/nwn-trn.win-x86
  - wine dub build -b release -a x86_64 :nwn-trn  &&  mv nwn-trn.exe bin/nwn-trn.win-x86_64

  - ./.travis/gh-pages/upload.sh

after_success:
    - bash <(curl -s https://codecov.io/bash)

notifications:
  email:
    - cromfr@gmail.com
